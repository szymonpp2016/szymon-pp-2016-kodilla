DROP TABLES  IF EXISTS BOOKS_AUD;

create table BOOKS_AUD (
EVENT_ID int(11) not null auto_increment,
EVENT_DATE datetime NOT NULL,
EVENT_TYPE VARCHAR(10) DEFAULT NULL,
BOOK_ID INT(11) NOT NULL,
OLD_TITLE VARCHAR(255),
NEW_TITLE VARCHAR(255),
OLD_PUBYEAR INT(4),
NEW_PUBYEAR INT(4),
OLD_BESTSELLER boolean,
NEW_BESTSELLER boolean,
PRIMARY KEY(`EVENT_ID`)
);


DROP TABLES  IF EXISTS READERS_AUD;

create table READERS_AUD (
EVENT_ID int(11) not null auto_increment,
EVENT_DATE datetime NOT NULL,
EVENT_TYPE VARCHAR(10) DEFAULT NULL,
READER_ID INT(11) NOT NULL,
OLD_FIRSTNAME VARCHAR(255),
NEW_FIRSTNAME VARCHAR(255),
OLD_LASTNAME VARCHAR(255),
NEW_LASTNAME VARCHAR(255),
OLD_PESELID VARCHAR(11),
NEW_PESELID VARCHAR(11),
OLD_VIP_LEVEL VARCHAR(20),
NEW_VIP_LEVEL VARCHAR(20),
PRIMARY KEY(`EVENT_ID`)
);


Drop trigger if exists READERS_INSERT;

DELIMITER $$

CREATE TRIGGER READERS_INSERT AFTER INSERT ON readers
FOR EACH ROW
BEGIN
	INSERT INTO READERS_AUD(EVENT_DATE, EVENT_TYPE, READER_ID, NEW_FIRSTNAME, NEW_LASTNAME,  NEW_PESELID, NEW_VIP_LEVEL)
					VALUES (CURTIME(), 'INSERT', NEW.READER_ID, NEW.FIRSTNAME,  NEW.LASTNAME, NEW.PESELID, NEW.VIP_LEVEL);
END $$

    DELIMITER ;




Drop trigger if exists BOOKS_INSERT;
 DELIMITER $$

CREATE TRIGGER BOOKS_INSERT AFTER INSERT ON books
FOR EACH ROW
BEGIN
	INSERT INTO BOOKS_AUD(EVENT_DATE, EVENT_TYPE, BOOK_ID, NEW_TITLE, NEW_PUBYEAR, NEW_BESTSELLER)
						VALUES (CURTIME(), 'INSERT', NEW.BOOK_ID, NEW.TITLE, NEW.PUBYEAR, NEW.BESTSELLER);
END $$

    DELIMITER ;


Drop trigger if exists BOOKS_UPDATER;

DELIMITER $$

CREATE TRIGGER BOOKS_UPDATER AFTER UPDATE ON books
FOR EACH ROW
BEGIN
	INSERT INTO BOOKS_AUD(EVENT_DATE, EVENT_TYPE, BOOK_ID, NEW_TITLE,  NEW_PUBYEAR, NEW_BESTSELLER, OLD_TITLE, OLD_PUBYEAR,  OLD_BESTSELLER)
					VALUES (CURTIME(), 'UPDATE', old.BOOK_ID, NEW.TITLE,  NEW.PUBYEAR, NEW.BESTSELLER, OLD.TITLE,  OLD.PUBYEAR, OLD.BESTSELLER);
END $$

    DELIMITER ;


    Drop trigger if exists BOOKS_DELETER;

DELIMITER $$

CREATE TRIGGER BOOKS_DELETER AFTER DELETE ON books
FOR EACH ROW
BEGIN
	INSERT INTO BOOKS_AUD(EVENT_DATE, EVENT_TYPE, BOOK_ID,  OLD_TITLE, OLD_PUBYEAR,  OLD_BESTSELLER)
					VALUES (CURTIME(), 'DELETE', old.BOOK_ID, OLD.TITLE,  OLD.PUBYEAR, OLD.BESTSELLER);
END $$

    DELIMITER ;


    INSERT INTO books (TITLE, PUBYEAR, BESTSELLER)
    VALUES("AAAA", 2015 , TRUE);

    COMMIT;

    SELECT * FROM books_aud;



    INSERT INTO READERS (FIRSTNAME,LASTNAME,PESELID,VIP_LEVEL)
    					VALUES("AAAA", "BBBB", "AAAAA", "GOLDEN");

    COMMIT;

    SELECT * FROM READERS_aud;



    UPDATE BOOKS SET TITLE = "AAAAAAA"
    WHERE BOOK_ID = 1;

    COMMIT;

    SELECT * FROM books_aud;


    DELETE FROM BOOKS WHERE BOOK_ID=11;

    COMMIT;

    SELECT * FROM books_aud;